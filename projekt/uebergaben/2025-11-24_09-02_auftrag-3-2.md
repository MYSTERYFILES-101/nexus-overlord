# √úBERGABE - AUFTRAG 3.2

## Datum & Zeit
- Datum: 2025-11-24
- Uhrzeit: 09:02

## Auftrag
- Nummer: 3.2
- Name: Sonnet: Auftr√§ge + Regelwerk
- Phase: 3 - Kachel 2: Phasen & Auftr√§ge generieren

## Status
- [x] Erledigt

---

## Was wurde gemacht

### 1. Service: Auftr√§ge-Generator
**Datei:** `app/services/auftraege_generator.py` (neu, 354 Zeilen)

**Funktionen:**
- `generate_auftraege(phasen_data, enterprise_plan)` - Hauptfunktion
  - Ruft Sonnet 4.5 via OpenRouter auf
  - Temperature: 0.7, Timeout: 120s
  - Input: Phasen-Struktur + Enterprise-Plan
  - Returns: Auftrags-Struktur als Dict
  
- `extract_json(response)` - JSON-Extraktion
  - Identisch zu phasen_generator.py
  - 4 Extraktionsmethoden
  - Robuste Fehlerbehandlung
  
- `validate_auftraege(data, phasen_data)` - Validierung
  - Pr√ºft Struktur und Required Fields
  - Validiert Phase-Nummern gegen phasen_data
  - Pr√ºft Auftragsnummern-Format (X.Y)
  - Validiert Schritte, Dateien, Regelwerk
  - Pflicht-Felder im Regelwerk
  
- `format_auftraege_for_display(data)` - Markdown-Output
  - Gruppiert Auftr√§ge nach Phase
  - Formatiert f√ºr Anzeige

**Prompt-Engineering:**
```python
AUFTRAEGE_PROMPT = """
Du bist ein erfahrener Software-Entwickler und Projekt-Manager.
Erstelle f√ºr jede Phase konkrete Auftr√§ge, die Claude Code ausf√ºhren kann.

KONTEXT:
- Claude Code wird diese Auftr√§ge nacheinander abarbeiten
- Jeder Auftrag muss eigenst√§ndig ausf√ºhrbar sein
- Erste Auftr√§ge: Setup/Grundlagen
- Letzte Auftr√§ge: Tests/Integration

AUSGABE:
- 2-5 Auftr√§ge pro Phase
- Auftragsnummer: "X.Y" Format
- Konkrete Schritte (3-6)
- Dateien mit Aktionen
- Regelwerk f√ºr Claude Code

JSON-STRUKTUR:
{
    "auftraege": [{
        "phase_nummer": 1,
        "auftrag_nummer": "1.1",
        "name": "...",
        "beschreibung": "...",
        "schritte": [...],
        "dateien": [{"pfad": "...", "aktion": "neu/√§ndern"}],
        "technische_details": [...],
        "erfolgs_kriterien": [...],
        "regelwerk": {
            "commit_message": "[1.1] ...",
            "uebergabe_pfad": "/projekt/uebergaben/...",
            "pflichten": [...]
        }
    }],
    "gesamt_auftraege": N,
    "geschaetzte_dauer": "X Stunden",
    "hinweise": "..."
}
"""
```

### 2. Routes in main.py
**Erweitert:** `app/main.py` (+67 Zeilen)

**Route 1:** `/projekt/<int:projekt_id>/auftraege/generieren` (POST)
- Startet Auftrags-Generierung
- L√§dt Projekt aus DB
- Pr√ºft phasen_data in Session
- Ruft generate_auftraege() auf
- Speichert in Session f√ºr Auftrag 3.3
- Error-Handling mit Flash-Messages
- Redirect zu Auftr√§ge-Anzeige

**Route 2:** `/projekt/<int:projekt_id>/auftraege` (GET)
- Zeigt generierte Auftr√§ge
- L√§dt aus Session
- Gruppiert Auftr√§ge nach Phase
- L√§dt Phasen-Namen aus phasen_data
- Rendert Template

### 3. Template: Auftr√§ge-Anzeige
**Datei:** `app/templates/projekt_auftraege.html` (neu, 232 Zeilen)

**Komponenten:**
- Header: "üìã AUFTR√ÑGE & REGELWERK"
- √úbersicht-Box:
  - Anzahl Auftr√§ge (gro√üe Zahl)
  - Anzahl Phasen
  - Gesch√§tzte Gesamtdauer
  - Gradient-Background (lila)
  
- Hinweise-Box (falls vorhanden):
  - Gelber Hintergrund
  - Umsetzungs-Hinweise von Sonnet
  
- Phasen-Liste (Collapsible):
  - Phase-Header (klickbar)
    - Phase-Badge (#)
    - Phase-Name
    - Auftr√§ge-Count
    - Toggle-Icon (‚ñº/‚ñ∂)
  - Phase-Content (expandierbar)
  
- Auftr√§ge-Cards (Collapsible):
  - Auftrag-Header (klickbar)
    - Auftragsnummer-Badge (blau)
    - Auftrags-Name
    - Toggle-Icon (‚ñº/‚ñ∂)
  - Auftrag-Content (expandierbar):
    - Beschreibung (grau-Box mit border-left)
    - Schritte (1-6, nummeriert)
    - Dateien (Icons + Pfad + Aktion)
    - Technische Details (Liste)
    - Erfolgs-Kriterien (Liste)
    - Regelwerk-Box (blau-lila Gradient):
      - Commit Message (Code-Block)
      - √úbergabe-Pfad (Code-Block)
      - Pflichten (Liste)
      
- Buttons:
  - "‚Üê Zur√ºck zu Phasen"
  - "‚úÖ Weiter zur Qualit√§tspr√ºfung" (Placeholder)
  
- JavaScript:
  - `togglePhase(phaseNr)` - Expandiert/Kollabiert Phase
  - `toggleAuftrag(auftragNr)` - Expandiert/Kollabiert Auftrag
  - Smooth Animation

### 4. Template: Phasen-Ergebnis erweitert
**Datei:** `app/templates/projekt_phasen_ergebnis.html` (erweitert)

**√Ñnderungen:**
- Button "Weiter zu Auftr√§gen":
  - Von `<button onclick="alert()">` zu `<form POST>`
  - Action: `/projekt/{id}/auftraege/generieren`
  - ID: generateAuftraegeBtn
  
- Loading-Overlay hinzugef√ºgt:
  - Fullscreen mit Spinner
  - "Sonnet 4.5 erstellt Auftr√§ge..."
  - "60-120 Sekunden"
  
- JavaScript:
  - Event-Listener auf Form-Submit
  - Zeigt Loading-Overlay
  - Disabled Button w√§hrend Loading

### 5. CSS-Styling
**Datei:** `static/css/style.css` (+354 Zeilen)

**Auftr√§ge-Container:**
- `.auftraege-container` - Max-width 1400px
- `.auftraege-overview-box` - 3 Stats mit Gradient
- `.auftraege-hinweise-box` - Gelbe Info-Box

**Phase-Sections:**
- `.phase-section` - Wei√üe Container
- `.phase-section-header` - Gradient, Klickbar
  - Hover: Darker Gradient
  - Cursor: Pointer
- `.phase-badge` - Nummer-Badge
- `.phase-name` - Titel (gro√ü, bold)
- `.phase-count` - Auftr√§ge-Count
- `.phase-toggle` - ‚ñº/‚ñ∂ Icon
- `.phase-section-content` - Collapsible Content

**Auftrag-Cards:**
- `.auftrag-card` - Grauer Background, Border
  - Hover: Blauer Border + Shadow
- `.auftrag-header` - Wei√üer Header, Klickbar
  - Hover: Grauer Background
- `.auftrag-nummer` - Blauer Badge (50px)
- `.auftrag-name` - Titel (bold)
- `.auftrag-toggle` - ‚ñº/‚ñ∂ Icon (blau)
- `.auftrag-content` - Collapsible Content (wei√ü)

**Auftrag-Details:**
- `.auftrag-beschreibung` - Grau-Box, border-left blau
- `.auftrag-steps` - Nummerierte Liste
- `.auftrag-dateien` - Flex-Column
  - `.datei-item` - Grau, border-left blau
  - `.datei-aktion` - Icon (‚ûï/‚úèÔ∏è)
    - Gr√ºn f√ºr "neu"
    - Gelb f√ºr "√§ndern"
  - `.datei-pfad` - Monospace Code
  - `.datei-aktion-label` - Uppercase Label
- `.auftrag-tech` - Liste
- `.auftrag-kriterien` - Liste

**Regelwerk-Box:**
- `.auftrag-regelwerk` - Gradient (blau-lila)
- `.regelwerk-item` - Margin-bottom
  - `strong` - Label
  - `code` - Code-Block (wei√ü, border-left)
- `.regelwerk-pflichten` - Liste

**Responsive:**
- Mobile: Stacked Layout
- Flex-Wrap f√ºr Title-Elemente

---

## Dateien

### Neu (2 Dateien):
- `app/services/auftraege_generator.py` (354 Zeilen)
- `app/templates/projekt_auftraege.html` (232 Zeilen)

### Aktualisiert (3 Dateien):
- `app/main.py` (+67 Zeilen, 2 neue Routes)
- `app/templates/projekt_phasen_ergebnis.html` (+14 Zeilen)
- `static/css/style.css` (+354 Zeilen)

**Gesamt: +1.021 Zeilen Code**

---

## GitHub
- Commit: [3.2] Sonnet Auftr√§ge + Regelwerk Generator
- Hash: 9323dd4
- Push: ‚úÖ Erfolgreich

---

## Wie es funktioniert

### User-Flow:
1. User sieht Phasen-Ergebnis
2. Klickt "‚úÖ Weiter zu Auftr√§gen"
3. Loading-Overlay erscheint
4. POST zu `/projekt/{id}/auftraege/generieren`
5. **Sonnet 4.5 analysiert Phasen + Enterprise-Plan (60-120s)**
6. JSON mit 2-5 Auftr√§gen pro Phase
7. Validierung + Session-Speicherung
8. Redirect zu `/projekt/{id}/auftraege`
9. Auftr√§ge gruppiert nach Phasen anzeigen
10. User kann Phasen/Auftr√§ge expandieren

### Sonnet-Workflow:
```
Phasen-Struktur (aus 3.1)
    +
Enterprise-Plan
    ‚Üì
AUFTRAEGE_PROMPT
    ‚Üì
Sonnet 4.5 (OpenRouter)
    ‚Üì
JSON-Response
    ‚Üì
extract_json()
    ‚Üì
validate_auftraege()
    ‚Üì
Session Storage
    ‚Üì
Gruppierung nach Phase
    ‚Üì
Auftr√§ge-Anzeige (Collapsible)
```

### Auftrags-Struktur:
```json
{
    "auftraege": [
        {
            "phase_nummer": 1,
            "auftrag_nummer": "1.1",
            "name": "Setup & Dependencies",
            "beschreibung": "Grundstruktur erstellen...",
            "schritte": [
                "requirements.txt erstellen",
                "Dependencies installieren",
                "Ordnerstruktur anlegen"
            ],
            "dateien": [
                {"pfad": "requirements.txt", "aktion": "neu"},
                {"pfad": "README.md", "aktion": "neu"}
            ],
            "technische_details": [
                "Python 3.11+",
                "Flask Framework"
            ],
            "erfolgs_kriterien": [
                "requirements.txt existiert",
                "Dependencies installiert"
            ],
            "regelwerk": {
                "commit_message": "[1.1] Setup & Dependencies",
                "uebergabe_pfad": "/projekt/uebergaben/YYYY-MM-DD_HH-MM_auftrag-1-1.md",
                "pflichten": [
                    "GitHub Commit erstellen",
                    "GitHub Push durchf√ºhren",
                    "√úbergabe-Datei schreiben",
                    "Status melden an User"
                ]
            }
        }
    ],
    "gesamt_auftraege": 12,
    "geschaetzte_dauer": "10-15 Stunden",
    "hinweise": "Strategische Empfehlungen..."
}
```

### Collapsible UI:
- Alle Phasen initial **expanded** (visible)
- Alle Auftr√§ge initial **collapsed** (hidden)
- Click auf Phase-Header: Toggle Phase-Content
- Click auf Auftrag-Header: Toggle Auftrag-Content
- Toggle-Icon: ‚ñº (expanded) / ‚ñ∂ (collapsed)

---

## N√§chster Auftrag
- Phase: 3 - Kachel 2
- Nummer: 3.3
- Name: Gemini: Qualit√§tspr√ºfung
- Beschreibung: Gemini 3 Pro pr√ºft die Auftr√§ge und gibt Feedback

---

## Erfolgs-Kriterien
- [x] Auftrags-Generator Service funktioniert
- [x] Sonnet 4.5 wird korrekt aufgerufen
- [x] JSON mit Auftr√§gen wird generiert
- [x] Jeder Auftrag hat: Nummer, Name, Schritte, Dateien
- [x] Regelwerk pro Auftrag vorhanden
- [x] Auftr√§ge in Session gespeichert
- [x] Template zeigt Auftr√§ge √ºbersichtlich
- [x] Phasen collapsible
- [x] Auftr√§ge collapsible
- [x] Dateien mit Icons (neu/√§ndern)
- [x] Regelwerk-Box mit Code-Blocks
- [x] Loading-Overlay funktioniert
- [x] Weiter-Button zu 3.3 (Placeholder)
- [x] Responsive Design
- [x] GitHub gepusht
- [x] √úbergabe geschrieben

---

## Technische Details

### OpenRouter API Call:
```python
client = get_client()
response = client.call_sonnet([
    {"role": "user", "content": prompt}
], temperature=0.7, timeout=120)
```

### Validierung:
- Phase-Nummern: 1 bis anzahl_phasen
- Auftragsnummern: Regex `^\d+\.\d+$`
- Schritte: Nicht-leere Liste
- Dateien: Liste (kann leer sein)
- Regelwerk: Dict mit 3 Pflicht-Feldern

### Session-Daten:
```python
session['auftraege_data'] = {
    "auftraege": [...],
    "gesamt_auftraege": 12,
    "geschaetzte_dauer": "10-15 Stunden",
    "hinweise": "..."
}
session['projekt_id'] = projekt_id
```

### JavaScript-Funktionen:
```javascript
function togglePhase(phaseNr) {
    const content = document.getElementById('phase-' + phaseNr);
    const toggle = document.getElementById('toggle-' + phaseNr);
    // Toggle display + icon
}

function toggleAuftrag(auftragNr) {
    const content = document.getElementById('auftrag-' + auftragNr);
    const toggle = document.getElementById('toggle-auftrag-' + auftragNr);
    // Toggle display + icon
}
```

---

## Statistik

**Code:**
- Service: 354 Zeilen
- Routes: +67 Zeilen
- Templates: 232 Zeilen (neu) + 14 Zeilen (erweitert)
- CSS: +354 Zeilen
- **Gesamt: +1.021 Zeilen**

**Features:**
- 2 neue Routes
- 1 neuer Service
- 1 neues Template
- 2 erweiterte Templates
- Collapsible UI (Phasen + Auftr√§ge)
- Regelwerk-Anzeige
- Loading-State

**Sonnet-F√§higkeiten:**
- Erstellt 2-5 Auftr√§ge pro Phase
- Konkrete, ausf√ºhrbare Schritte
- Dateinamen und Pfade
- Regelwerk f√ºr Claude Code
- Commit-Messages
- √úbergabe-Pfade
- Pflichten-Liste

---

**√úbergeben von:** Claude Code (Sonnet 4.5)  
**Zeitstempel:** 2025-11-24 09:02 UTC  
**Phase:** 3 von 7 (Auftrag 2 von 4)  
**Fortschritt Phase 3:** 50% (2/4)  

‚úÖ SONNET AUFTR√ÑGE + REGELWERK FERTIG!

üéØ NEXT: Auftrag 3.3 - Gemini pr√ºft Auftr√§ge-Qualit√§t
